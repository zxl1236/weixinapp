# 生产环境部署指南

## 📋 概述

本指南将帮助您将后端从开发模式切换到生产模式，启用真实的微信支付功能。

## 🔧 切换到生产模式的步骤

### 1. 修改环境变量

编辑服务器上的 `.env` 文件，将 `NODE_ENV` 设置为 `production`：

```bash
NODE_ENV=production
```

### 2. 配置微信支付参数

确保以下微信支付相关环境变量都已正确配置：

```bash
# 微信小程序配置
WECHAT_APPID=你的小程序AppID
WECHAT_SECRET=你的小程序Secret

# 微信支付配置
WECHAT_MCHID=你的商户号
WECHAT_API_KEY=你的API密钥（32位字符串）
WECHAT_CERT_PATH=./certs/apiclient_cert.pem
WECHAT_KEY_PATH=./certs/apiclient_key.pem
WECHAT_NOTIFY_URL=https://你的域名.com/api/payment/notify
```

### 3. 上传微信支付证书

1. 登录微信商户平台（pay.weixin.qq.com）
2. 进入「账户中心」->「API安全」->「API证书」
3. 下载证书文件（通常包含 `apiclient_cert.pem` 和 `apiclient_key.pem`）
4. 将证书文件上传到服务器的 `backend/certs/` 目录

```bash
# 在服务器上创建证书目录
mkdir -p /var/www/k12-backend/backend/certs

# 上传证书文件（使用 scp 或其他方式）
# apiclient_cert.pem -> /var/www/k12-backend/backend/certs/
# apiclient_key.pem -> /var/www/k12-backend/backend/certs/
```

**⚠️ 安全提示：**
- 证书文件包含敏感信息，请妥善保管
- 不要将证书文件提交到代码仓库
- 建议设置证书文件权限为 600（仅所有者可读写）

```bash
chmod 600 /var/www/k12-backend/backend/certs/apiclient_cert.pem
chmod 600 /var/www/k12-backend/backend/certs/apiclient_key.pem
```

### 4. 配置支付回调URL

在微信商户平台配置支付回调URL：
1. 进入「产品中心」->「开发配置」->「支付配置」
2. 设置「支付回调URL」为：`https://你的域名.com/api/payment/notify`
3. 确保该URL可以通过公网访问（HTTPS）

### 5. 验证配置

运行配置检查脚本：

```bash
cd /var/www/k12-backend/backend
node check-config.js
```

确保所有检查项都通过，特别是：
- ✅ 环境: production (生产模式)
- ✅ 当前为生产模式，将使用真实微信支付
- ✅ 所有微信支付配置项都已配置
- ✅ 证书文件存在

### 6. 重启服务

修改配置后，需要重启后端服务：

```bash
# 如果使用 PM2
pm2 restart k12-backend

# 如果使用 systemd
systemctl restart k12-backend

# 如果直接运行
# 先停止当前进程（Ctrl+C），然后重新启动
node server.js
```

### 7. 验证服务状态

检查服务日志，确认：
- ✅ 没有 "开发模式" 警告
- ✅ 显示 "微信支付初始化成功"
- ✅ 服务器启动成功，环境为 production

```bash
# 查看日志
pm2 logs k12-backend

# 或直接查看输出
tail -f /var/www/k12-backend/backend/logs/app.log
```

## 🔍 生产环境检查清单

在部署到生产环境前，请确认以下所有项：

### 环境配置
- [ ] `NODE_ENV=production` 已设置
- [ ] 所有敏感信息都通过环境变量配置，未硬编码
- [ ] `.env` 文件权限设置为 600（仅所有者可读写）

### 微信小程序配置
- [ ] `WECHAT_APPID` 已配置（生产环境的小程序AppID）
- [ ] `WECHAT_SECRET` 已配置（生产环境的小程序Secret）

### 微信支付配置
- [ ] `WECHAT_MCHID` 已配置（商户号）
- [ ] `WECHAT_API_KEY` 已配置（32位API密钥）
- [ ] `WECHAT_CERT_PATH` 指向正确的证书文件路径
- [ ] `WECHAT_KEY_PATH` 指向正确的密钥文件路径
- [ ] `WECHAT_NOTIFY_URL` 已配置为生产环境的回调URL
- [ ] 证书文件已上传到服务器
- [ ] 证书文件权限已设置为 600
- [ ] 在微信商户平台已配置支付回调URL

### 服务器配置
- [ ] 服务器端口已正确配置（默认 3000）
- [ ] 防火墙已开放必要端口
- [ ] HTTPS 已配置（支付回调需要 HTTPS）
- [ ] 域名已正确解析到服务器IP

### 数据库配置
- [ ] 数据库类型已配置（SQLite 或 MongoDB）
- [ ] 数据库文件/连接已正确配置
- [ ] 数据库文件权限已正确设置

### 安全配置
- [ ] `ADMIN_API_KEY` 已设置（管理后台API密钥）
- [ ] CORS 已正确配置（`ALLOWED_ORIGINS`）
- [ ] 日志文件权限已正确设置

### 服务运行
- [ ] 服务已成功启动
- [ ] 健康检查接口可访问：`http://你的域名:3000/health`
- [ ] 日志中无错误信息
- [ ] 微信支付初始化成功

## 🧪 测试支付功能

切换到生产模式后，建议进行以下测试：

### 1. 创建测试订单
```bash
curl -X POST http://你的域名:3000/api/payment/create-order \
  -H "Content-Type: application/json" \
  -d '{
    "openid": "测试openid",
    "planId": "monthly",
    "planName": "月度会员",
    "price": 29.9,
    "duration": 30
  }'
```

### 2. 获取支付参数
```bash
curl -X POST http://你的域名:3000/api/payment/get-params \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "K12..."
  }'
```

### 3. 验证支付回调
- 完成一笔真实支付（使用测试金额）
- 检查服务器日志，确认回调已接收并处理
- 验证订单状态已更新为 "paid"
- 验证用户会员状态已更新

## ⚠️ 常见问题

### 问题1：仍然显示"开发模式"警告

**原因：** `NODE_ENV` 环境变量未正确设置

**解决：**
1. 检查 `.env` 文件中 `NODE_ENV=production`
2. 确保重启了服务
3. 检查环境变量是否被其他配置覆盖

### 问题2：微信支付初始化失败

**原因：** 证书文件路径错误或证书文件不存在

**解决：**
1. 检查证书文件路径是否正确
2. 确认证书文件已上传到服务器
3. 检查文件权限（应为 600）
4. 验证证书文件内容是否正确

### 问题3：支付回调验证失败

**原因：** 回调URL配置错误或签名验证失败

**解决：**
1. 确认 `WECHAT_NOTIFY_URL` 配置正确
2. 确认回调URL在微信商户平台已配置
3. 检查回调URL是否可通过公网访问（HTTPS）
4. 查看日志中的详细错误信息

### 问题4：支付参数获取失败

**原因：** 微信支付配置不完整或API调用失败

**解决：**
1. 运行 `node check-config.js` 检查配置
2. 查看日志中的详细错误信息
3. 确认微信商户平台配置正确
4. 验证 AppID 和商户号是否匹配

## 📞 技术支持

如遇到问题，请：
1. 查看服务器日志：`pm2 logs k12-backend` 或查看日志文件
2. 运行配置检查：`node check-config.js`
3. 检查微信商户平台配置
4. 查看微信支付文档：https://pay.weixin.qq.com/docs/merchant/

## 🔄 回退到开发模式

如果需要临时回退到开发模式（不推荐在生产环境使用）：

```bash
# 修改 .env 文件
NODE_ENV=development

# 重启服务
pm2 restart k12-backend
```

**注意：** 开发模式下支付功能将被模拟，不会产生真实支付。

