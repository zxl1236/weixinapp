# æ›´æ–°è¯´æ˜ - ä¼šå‘˜çŠ¶æ€ä¿®å¤å’ŒTTSä¼˜åŒ–

## ğŸ“‹ æœ¬æ¬¡æ›´æ–°å†…å®¹

### 1. ä¼šå‘˜åˆ°æœŸæ—¶é—´ä¿®å¤
- **é—®é¢˜**ï¼šä¼šå‘˜åˆ°æœŸæ—¶é—´è®¡ç®—é€»è¾‘ä¸ä¸€è‡´ï¼Œå¯èƒ½ä»å½“å‰è¿‡æœŸæ—¶é—´ç»­æœŸ
- **ä¿®å¤**ï¼šç»Ÿä¸€æ”¹ä¸ºä»ä»˜æ¬¾æˆåŠŸåå¼€å§‹è®¡ç®—ï¼Œå›ºå®š365å¤©ï¼ˆä¸€å¹´ï¼‰

### 2. åå°ç®¡ç†ä¼šå‘˜çŠ¶æ€åŒæ­¥
- **é—®é¢˜**ï¼šä»˜è´¹å®Œæˆåï¼Œåå°ç®¡ç†ç•Œé¢ä»æ˜¾ç¤ºç”¨æˆ·ä¸º"å…è´¹ç”¨æˆ·"
- **ä¿®å¤**ï¼šåœ¨ `getUsers` æ¥å£ä¸­æ·»åŠ è‡ªåŠ¨åŒæ­¥é€»è¾‘ï¼Œæ£€æŸ¥è®¢å•çŠ¶æ€å¹¶ä¿®æ­£ç”¨æˆ·ä¼šå‘˜çŠ¶æ€

### 3. åå°æ›´æ–°ä¼šå‘˜çŠ¶æ€ä¼˜åŒ–
- **é—®é¢˜**ï¼šåå°æ›´æ–°ä¼šå‘˜çŠ¶æ€åï¼Œç”¨æˆ·ç«¯æ²¡æœ‰æ›´æ–°
- **ä¿®å¤**ï¼šæ”¹è¿› `updateUserMembership` æ¥å£ï¼Œç¡®ä¿çŠ¶æ€å’Œè¿‡æœŸæ—¶é—´çš„ä¸€è‡´æ€§

### 4. TTSéŸ³é¢‘ä¼˜åŒ–
- ä¿®å¤ Content-Type åˆ¤æ–­é€»è¾‘ï¼Œé¿å…è¯¯åˆ¤
- æ·»åŠ ç™¾åº¦TTSè¶…æ—¶æœºåˆ¶ï¼ˆ600msï¼‰
- ä¼˜åŒ–éŸ³é¢‘ä¸‹è½½ç»“æœæ ¡éªŒ

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨

### åç«¯æ–‡ä»¶
1. `backend/controllers/paymentController.js`
   - ä¿®å¤ä¼šå‘˜åˆ°æœŸæ—¶é—´è®¡ç®—é€»è¾‘
   - ç»Ÿä¸€æ”¹ä¸ºä»ä»˜æ¬¾æ—¶é—´å¼€å§‹è®¡ç®—365å¤©

2. `backend/controllers/adminController.js`
   - æ·»åŠ è‡ªåŠ¨åŒæ­¥ä¼šå‘˜çŠ¶æ€é€»è¾‘
   - æ”¹è¿› `updateUserMembership` æ¥å£

3. `backend/services/baiduTTS.js`
   - ä¿®æ­£ `lan` å‚æ•°ä¸ºå›ºå®šå€¼ `'zh'`
   - ä¼˜åŒ–å‘éŸ³äººé€‰æ‹©ï¼ˆåº¦åšæ–‡ï¼Œç²¾å“éŸ³åº“ï¼‰
   - æ·»åŠ éŸ³é¢‘æ ¼å¼å‚æ•°

4. `backend/controllers/ttsController.js`
   - æ›´æ–°å‚æ•°å¤„ç†é€»è¾‘

### å‰ç«¯æ–‡ä»¶
1. `frontend/utils/audioManager.js`
   - æ·»åŠ  `ENABLE_CDN_AUDIO` å¼€å…³
   - æ·»åŠ  `BAIDU_TTS_TIMEOUT_MS` è¶…æ—¶é…ç½®
   - ä¿®å¤ Content-Type åˆ¤æ–­é€»è¾‘
   - å®ç°ç™¾åº¦TTSä¼˜å…ˆï¼Œè¶…æ—¶å›é€€æœ‰é“
   - æ·»åŠ è‡ªåŠ¨åˆ‡æ¢é‡æ’­åŠŸèƒ½

2. `frontend/utils/baiduTTS.js`
   - å…¼å®¹å¤šç§è¿”å›æ ¼å¼
   - æ·»åŠ è°ƒè¯•æ—¥å¿—
   - ç§»é™¤åºŸå¼ƒçš„ `lang` å‚æ•°

## ğŸš€ æ›´æ–°åˆ°æœåŠ¡å™¨æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Gitï¼ˆæ¨èï¼‰

å¦‚æœæœåŠ¡å™¨å·²é…ç½® Gitï¼Œå¯ä»¥æ‰§è¡Œï¼š

```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@your-server

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/k12-backend/backend
# æˆ–
cd /www/wwwroot/k12-backend/backend

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main
# æˆ–
git pull origin master

# é‡å¯æœåŠ¡
pm2 restart k12-backend
```

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶

å¦‚æœæ— æ³•ä½¿ç”¨ Gitï¼Œå¯ä»¥æ‰‹åŠ¨ä¸Šä¼ ä»¥ä¸‹æ–‡ä»¶ï¼š

#### åç«¯æ–‡ä»¶ï¼ˆä¸Šä¼ åˆ°æœåŠ¡å™¨ `backend/` ç›®å½•ï¼‰
- `backend/controllers/paymentController.js`
- `backend/controllers/adminController.js`
- `backend/services/baiduTTS.js`
- `backend/controllers/ttsController.js`

#### å‰ç«¯æ–‡ä»¶ï¼ˆä¸Šä¼ åˆ°æœåŠ¡å™¨ `frontend/utils/` ç›®å½•ï¼‰
- `frontend/utils/audioManager.js`
- `frontend/utils/baiduTTS.js`

#### ä¸Šä¼ åæ“ä½œ
```bash
# SSH ç™»å½•æœåŠ¡å™¨
ssh root@your-server

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /var/www/k12-backend/backend
# æˆ–
cd /www/wwwroot/k12-backend/backend

# é‡å¯æœåŠ¡
pm2 restart k12-backend

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤
pm2 logs k12-backend --lines 50
```

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ SCP ä¸Šä¼ 

```bash
# åœ¨æœ¬åœ°æ‰§è¡Œï¼ˆWindows PowerShellï¼‰
# ä¸Šä¼ åç«¯æ–‡ä»¶
scp backend/controllers/paymentController.js root@your-server:/var/www/k12-backend/backend/controllers/
scp backend/controllers/adminController.js root@your-server:/var/www/k12-backend/backend/controllers/
scp backend/services/baiduTTS.js root@your-server:/var/www/k12-backend/backend/services/
scp backend/controllers/ttsController.js root@your-server:/var/www/k12-backend/backend/controllers/

# ä¸Šä¼ å‰ç«¯æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
scp frontend/utils/audioManager.js root@your-server:/path/to/frontend/utils/
scp frontend/utils/baiduTTS.js root@your-server:/path/to/frontend/utils/

# ç„¶å SSH ç™»å½•æœåŠ¡å™¨é‡å¯æœåŠ¡
ssh root@your-server "cd /var/www/k12-backend/backend && pm2 restart k12-backend"
```

## âœ… éªŒè¯æ›´æ–°

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
pm2 status
pm2 logs k12-backend --lines 50
```

### 2. æµ‹è¯•ä¼šå‘˜çŠ¶æ€åŒæ­¥
- åœ¨åå°ç®¡ç†ç•Œé¢æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
- æ£€æŸ¥å·²æ”¯ä»˜ç”¨æˆ·æ˜¯å¦æ˜¾ç¤ºä¸º"ä¼šå‘˜"
- æ£€æŸ¥ä¼šå‘˜åˆ°æœŸæ—¶é—´æ˜¯å¦æ­£ç¡®ï¼ˆä»˜æ¬¾æ—¶é—´ + 365å¤©ï¼‰

### 3. æµ‹è¯•TTSåŠŸèƒ½
- åœ¨å°ç¨‹åºä¸­æµ‹è¯•å•è¯å‘éŸ³
- æ£€æŸ¥æ˜¯å¦ä¼˜å…ˆä½¿ç”¨ç™¾åº¦TTS
- æ£€æŸ¥è¶…æ—¶å›é€€æ˜¯å¦æ­£å¸¸

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ•°æ®**ï¼šæ›´æ–°å‰å»ºè®®å¤‡ä»½æ•°æ®åº“
   ```bash
   # SQLite
   cp backend/data/k12_vocabulary.db backend/data/k12_vocabulary.db.backup
   ```

2. **ç¯å¢ƒå˜é‡**ï¼šç¡®ä¿æœåŠ¡å™¨ä¸Šçš„ `.env` æ–‡ä»¶åŒ…å«ç™¾åº¦TTSé…ç½®
   ```env
   BAIDU_TTS_APP_ID=7342191
   BAIDU_TTS_API_KEY=wdfkj6O8WFuejHXewR0ZQCg4
   BAIDU_TTS_SECRET_KEY=ZIBV6PO1xGO38g1UP0dlPvRhPepnauws
   ```

3. **é‡å¯æœåŠ¡**ï¼šæ›´æ–°åå¿…é¡»é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ

## ğŸ” å¸¸è§é—®é¢˜

### Q: æ›´æ–°åä¼šå‘˜çŠ¶æ€ä»ç„¶ä¸æ­£ç¡®ï¼Ÿ
A: æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æœ‰"æ£€æµ‹åˆ°æ•°æ®ä¸ä¸€è‡´ï¼Œå·²åŒæ­¥ç”¨æˆ·ä¼šå‘˜çŠ¶æ€"çš„æ—¥å¿—ã€‚å¦‚æœæ²¡æœ‰ï¼Œå¯èƒ½æ˜¯è®¢å•æ•°æ®æœ‰é—®é¢˜ã€‚

### Q: TTS åŠŸèƒ½ä¸å·¥ä½œï¼Ÿ
A: æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤ç™¾åº¦TTSé…ç½®æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠ `/api/tts` æ¥å£æ˜¯å¦æ­£å¸¸å“åº”ã€‚

### Q: å¦‚ä½•å›æ»šæ›´æ–°ï¼Ÿ
A: å¦‚æœæœ‰ Gitï¼Œå¯ä»¥ä½¿ç”¨ `git reset --hard <commit-hash>` å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ã€‚

---

**æ›´æ–°æ—¶é—´**: 2024-12-19
**æ›´æ–°ç‰ˆæœ¬**: v1.1.0

