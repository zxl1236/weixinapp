# 激活码生成说明

## 概述

激活码用于用户免费激活会员功能，每个激活码**只能使用一次**，使用后会自动标记为已使用。

## 生成激活码

### 方法一：使用命令行脚本（推荐）

```bash
# 进入后端目录
cd backend

# 生成单个激活码（默认长度10）
node scripts/create-activation-code.js

# 生成10个激活码（默认长度10）
node scripts/create-activation-code.js 10

# 生成10个长度为12的激活码
node scripts/create-activation-code.js 10 12
```

**参数说明：**
- 第一个参数：生成数量（1-1000，默认：1）
- 第二个参数：激活码长度（6-20，默认：10）

**示例输出：**
```
🔑 开始生成激活码...
   数量: 10
   长度: 10

📦 使用 SQLite 数据库...
⏳ 正在生成激活码...

   已生成: 10/10

✅ 激活码生成完成！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 生成的激活码列表：

     1. ABC123XYZ9
     2. DEF456UVW8
     ...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 统计信息：
   ✅ 成功生成: 10 个
   📝 状态: 未使用
   🔒 安全性: 每个激活码只能使用一次

💾 激活码已保存到文件: backend/scripts/activation-codes-1234567890.txt
```

### 方法二：使用管理后台 API

通过管理后台 API 接口生成激活码：

```bash
# 生成单个激活码
curl -X POST http://localhost:3000/api/admin/activation-codes \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"count": 1, "length": 10}'

# 生成10个激活码
curl -X POST http://localhost:3000/api/admin/activation-codes \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"count": 10, "length": 12}'
```

**请求参数：**
- `count`: 生成数量（可选，默认：1）
- `length`: 激活码长度（可选，默认：10）

**响应示例：**
```json
{
  "success": true,
  "data": [
    {
      "_id": "...",
      "code": "ABC123XYZ9",
      "used": false,
      "usedBy": null,
      "usedAt": null,
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "message": "成功生成 10 个激活码"
}
```

## 查看激活码列表

### 使用管理后台 API

```bash
# 查看所有激活码
curl -X GET http://localhost:3000/api/admin/activation-codes \
  -H "X-API-Key: YOUR_API_KEY"

# 查看未使用的激活码
curl -X GET "http://localhost:3000/api/admin/activation-codes?used=false" \
  -H "X-API-Key: YOUR_API_KEY"

# 查看已使用的激活码
curl -X GET "http://localhost:3000/api/admin/activation-codes?used=true" \
  -H "X-API-Key: YOUR_API_KEY"
```

## 激活码特性

### 1. 唯一性保证
- 每个激活码在数据库中都是唯一的
- 生成时会自动检查重复，确保不会生成重复的激活码

### 2. 一次性使用
- 每个激活码只能使用一次
- 使用后会自动标记为 `used: true`
- 记录使用者的 `openid` 和使用时间 `usedAt`

### 3. 字符集
- 使用大写字母和数字
- 排除容易混淆的字符：`0`, `O`, `I`, `1`
- 字符集：`ABCDEFGHJKLMNPQRSTUVWXYZ23456789`

### 4. 安全性
- 激活码不区分大小写（自动转换为大写）
- 使用时会验证激活码是否存在
- 使用时会检查是否已被使用
- 使用时会检查用户是否已激活（防止重复激活）

## 用户使用流程

1. 用户进入支付页面
2. 选择"激活码激活"选项
3. 输入激活码（不区分大小写）
4. 点击"激活"按钮
5. 系统验证激活码：
   - 检查激活码是否存在
   - 检查激活码是否已被使用
   - 检查用户是否已激活
6. 验证通过后：
   - 标记激活码为已使用
   - 激活用户会员状态
   - 返回成功提示

## 数据库结构

### SQLite / MongoDB 字段说明

- `code`: 激活码（唯一，不区分大小写）
- `used`: 是否已使用（布尔值）
- `usedBy`: 使用者的 openid（使用后记录）
- `usedAt`: 使用时间（使用后记录）
- `createdAt`: 创建时间
- `updatedAt`: 更新时间

## 注意事项

1. **批量生成建议**：建议每次生成不超过 1000 个，避免数据库压力
2. **激活码长度**：建议使用 10-12 位，太短容易被猜测，太长不便于输入
3. **保存激活码**：脚本会自动将激活码保存到文本文件，请妥善保管
4. **分发激活码**：建议通过安全渠道分发，避免泄露
5. **定期清理**：可以定期查看已使用的激活码，了解使用情况

## 常见问题

### Q: 激活码可以重复使用吗？
A: 不可以。每个激活码只能使用一次，使用后会自动标记为已使用。

### Q: 激活码区分大小写吗？
A: 不区分。系统会自动将输入的激活码转换为大写进行验证。

### Q: 如何查看某个激活码是否已被使用？
A: 使用管理后台 API 查询激活码列表，或直接查询数据库。

### Q: 可以手动标记激活码为未使用吗？
A: 可以，但需要直接操作数据库，不建议这样做。建议生成新的激活码。

### Q: 激活码会过期吗？
A: 当前版本激活码不会过期，只要未使用就可以一直使用。如需添加过期功能，需要修改模型和验证逻辑。

