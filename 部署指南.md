# åç«¯æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ PM2ï¼ˆæ¨èï¼‰

#### 1. å®‰è£… PM2
```bash
npm install -g pm2
```

#### 2. é…ç½®ç¯å¢ƒå˜é‡
```bash
cd backend
cp .env.production .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å†™å®é™…é…ç½®
```

#### 3. å®‰è£…ä¾èµ–
```bash
npm install --production
```

#### 4. å¯åŠ¨æœåŠ¡
```bash
pm2 start server.js --name k12-backend
```

#### 5. è®¾ç½®å¼€æœºè‡ªå¯
```bash
pm2 startup
pm2 save
```

#### 6. æŸ¥çœ‹çŠ¶æ€
```bash
pm2 status
pm2 logs k12-backend
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Docker

#### 1. åˆ›å»º Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install --production

COPY . .

EXPOSE 3000

CMD ["node", "server.js"]
```

#### 2. æ„å»ºé•œåƒ
```bash
docker build -t k12-backend .
```

#### 3. è¿è¡Œå®¹å™¨
```bash
docker run -d \
  --name k12-backend \
  -p 3000:3000 \
  --env-file .env \
  k12-backend
```

### æ–¹å¼ä¸‰ï¼šç›´æ¥è¿è¡Œ

#### 1. å®‰è£…ä¾èµ–
```bash
npm install --production
```

#### 2. é…ç½®ç¯å¢ƒå˜é‡
```bash
cp .env.production .env
# ç¼–è¾‘ .env æ–‡ä»¶
```

#### 3. å¯åŠ¨æœåŠ¡
```bash
node server.js
```

#### 4. ä½¿ç”¨ nohup åå°è¿è¡Œ
```bash
nohup node server.js > server.log 2>&1 &
```

---

## ğŸŒ æœåŠ¡å™¨é…ç½®

### Nginx åå‘ä»£ç†é…ç½®

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    # åå‘ä»£ç†åˆ° Node.js
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # é™æ€æ–‡ä»¶ï¼ˆç®¡ç†åå°ï¼‰
    location /admin {
        proxy_pass http://localhost:3000;
    }
}
```

### é˜²ç«å¢™é…ç½®

```bash
# å¼€æ”¾ç«¯å£
sudo ufw allow 3000/tcp
sudo ufw allow 443/tcp
sudo ufw allow 80/tcp
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### PM2 ç›‘æ§

```bash
# æŸ¥çœ‹å®æ—¶ç›‘æ§
pm2 monit

# æŸ¥çœ‹æ—¥å¿—
pm2 logs k12-backend

# é‡å¯æœåŠ¡
pm2 restart k12-backend

# åœæ­¢æœåŠ¡
pm2 stop k12-backend
```

### æ—¥å¿—æ–‡ä»¶ä½ç½®

- PM2æ—¥å¿—ï¼š`~/.pm2/logs/`
- åº”ç”¨æ—¥å¿—ï¼šæŸ¥çœ‹ `backend/utils/logger.js` é…ç½®

---

## ğŸ”’ å®‰å…¨é…ç½®

### 1. ç¯å¢ƒå˜é‡ä¿æŠ¤
- âœ… ä¸è¦å°† `.env` æ–‡ä»¶æäº¤åˆ° Git
- âœ… ä½¿ç”¨å¼ºå¯†ç å’Œå¯†é’¥
- âœ… å®šæœŸæ›´æ–°å¯†é’¥

### 2. HTTPS é…ç½®
- âœ… ä½¿ç”¨æœ‰æ•ˆçš„ SSL è¯ä¹¦
- âœ… å¼ºåˆ¶ HTTPS è®¿é—®
- âœ… é…ç½® HSTS

### 3. æ•°æ®åº“å®‰å…¨
- âœ… ä½¿ç”¨å¼ºå¯†ç 
- âœ… é™åˆ¶æ•°æ®åº“è®¿é—®IP
- âœ… å®šæœŸå¤‡ä»½æ•°æ®

### 4. API å®‰å…¨
- âœ… ä½¿ç”¨ CORS é™åˆ¶æ¥æº
- âœ… éªŒè¯è¯·æ±‚å‚æ•°
- âœ… é˜²æ­¢ SQL æ³¨å…¥ï¼ˆMongoDB å·²å†…ç½®é˜²æŠ¤ï¼‰
- âœ… é™åˆ¶è¯·æ±‚é¢‘ç‡

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### 1. å¤‡ä»½æ•°æ®
```bash
# MongoDB å¤‡ä»½
mongodump --uri="your-mongodb-uri" --out=/backup/$(date +%Y%m%d)
```

### 2. æ›´æ–°ä»£ç 
```bash
git pull origin main
cd backend
npm install --production
```

### 3. é‡å¯æœåŠ¡
```bash
pm2 restart k12-backend
```

### 4. æ£€æŸ¥çŠ¶æ€
```bash
pm2 status
pm2 logs k12-backend --lines 50
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

1. **æ£€æŸ¥ç«¯å£å ç”¨**
   ```bash
   lsof -i :3000
   # æˆ–
   netstat -tulpn | grep 3000
   ```

2. **æ£€æŸ¥ç¯å¢ƒå˜é‡**
   ```bash
   cat .env
   ```

3. **æŸ¥çœ‹é”™è¯¯æ—¥å¿—**
   ```bash
   pm2 logs k12-backend --err
   ```

### æ•°æ®åº“è¿æ¥å¤±è´¥

1. **æ£€æŸ¥ MongoDB URI**
   ```bash
   # æµ‹è¯•è¿æ¥
   mongosh "your-mongodb-uri"
   ```

2. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
   ```bash
   ping your-mongodb-host
   ```

3. **æ£€æŸ¥é˜²ç«å¢™**
   ```bash
   # ç¡®ä¿ MongoDB ç«¯å£å¼€æ”¾
   ```

### æ”¯ä»˜å›è°ƒå¤±è´¥

1. **æ£€æŸ¥å›è°ƒURL**
   - ç¡®ä¿URLå¯å…¬ç½‘è®¿é—®
   - ç¡®ä¿ä½¿ç”¨ HTTPS
   - æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®

2. **æ£€æŸ¥è¯ä¹¦**
   - ç¡®ä¿è¯ä¹¦æ–‡ä»¶å­˜åœ¨
   - ç¡®ä¿è¯ä¹¦è·¯å¾„æ­£ç¡®
   - ç¡®ä¿è¯ä¹¦æœªè¿‡æœŸ

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¯ç”¨ Gzip å‹ç¼©
åœ¨ Nginx é…ç½®ä¸­æ·»åŠ ï¼š
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript;
```

### 2. ä½¿ç”¨ CDN
- é™æ€èµ„æºä½¿ç”¨ CDN
- å‡å°‘æœåŠ¡å™¨è´Ÿè½½

### 3. æ•°æ®åº“ä¼˜åŒ–
- æ·»åŠ ç´¢å¼•
- ä¼˜åŒ–æŸ¥è¯¢
- ä½¿ç”¨è¿æ¥æ± 

### 4. ç¼“å­˜ç­–ç•¥
- ä½¿ç”¨ Redis ç¼“å­˜ï¼ˆå¦‚éœ€è¦ï¼‰
- è®¾ç½®åˆç†çš„ç¼“å­˜æ—¶é—´

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœåŠ¡å™¨æ—¥å¿—
2. æ•°æ®åº“è¿æ¥
3. ç½‘ç»œé…ç½®
4. ç¯å¢ƒå˜é‡é…ç½®

