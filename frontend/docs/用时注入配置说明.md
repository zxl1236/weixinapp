# 微信小程序「用时注入」配置说明

## 功能说明

「用时注入」可以指定一部分自定义组件不在小程序启动时注入，而是在真正渲染的时候才进行注入，从而减少小程序启动时的代码包大小，提升启动速度。

## 前置条件

1. **基础库版本**：2.11.2 及以上版本（推荐 2.20.1 及以上）
2. **工具版本**：1.05.2111300 及以上版本
3. **已开启按需注入**：在 `app.json` 中配置 `"lazyCodeLoading": "requiredComponents"`

## 配置步骤

### 1. 在 app.json 中开启按需注入

```json
{
  "lazyCodeLoading": "requiredComponents"
}
```

### 2. 创建占位组件

占位组件用于在真正组件加载前显示，已创建在 `components/placeholder/index`。

### 3. 为组件配置占位组件

有两种方式配置占位组件：

#### 在使用组件的页面中配置（推荐方式）

在页面的 `xxx.json` 文件中，在 `usingComponents` 中配置：

```json
{
  "usingComponents": {
    "my-component": "/components/my-component/index"
  },
  "componentPlaceholder": {
    "my-component": "components/placeholder/index"
  }
}
```

## 使用示例

### 示例 1：为页面中的自定义组件配置用时注入

假设在 `pages/payment/payment.json` 中使用了一个自定义组件：

```json
{
  "usingComponents": {
    "payment-form": "/components/payment-form/index"
  },
  "componentPlaceholder": {
    "payment-form": "components/placeholder/index"
  }
}
```

### 示例 2：为多个组件配置占位组件

```json
{
  "usingComponents": {
    "component-a": "/components/component-a/index",
    "component-b": "/components/component-b/index"
  },
  "componentPlaceholder": {
    "component-a": "components/placeholder/index",
    "component-b": "components/placeholder/index"
  }
}
```

## 工作原理

1. **启动时**：配置了占位组件的自定义组件不会被注入
2. **首次渲染前**：该组件不会被注入
3. **首次渲染时**：
   - 组件会被渲染为对应的占位组件
   - 渲染流程结束后开始注入
   - 注入结束后，占位组件被替换回对应组件

## 注意事项

1. **首屏组件**：不建议为首屏必须显示的组件配置用时注入，因为会影响首屏渲染
2. **tabBar 组件**：`custom-tab-bar` 是首屏组件，通常不建议使用用时注入
3. **占位组件**：占位组件应该尽量简单，避免复杂的逻辑和样式
4. **兼容性**：基础库 2.11.2 以下版本会忽略此配置，按正常方式加载

## 适用场景

适合使用「用时注入」的组件：
- ✅ 非首屏组件
- ✅ 大型组件（代码量较大）
- ✅ 不常用的组件
- ✅ 条件渲染的组件（如弹窗、抽屉等）

不适合使用「用时注入」的组件：
- ❌ 首屏必须显示的组件
- ❌ tabBar 自定义组件
- ❌ 启动页组件
- ❌ 体积很小的组件（收益不明显）

## 当前项目配置

- ✅ `app.json` 已配置 `lazyCodeLoading: "requiredComponents"`
- ✅ 已创建占位组件 `components/placeholder/index`
- ✅ `project.config.json` 已配置基础库版本 `2.20.1`

## 配置验证

配置完成后，在微信开发者工具中：
1. 工具版本选择 1.05.2111300 及以上
2. 基础库选择 2.20.1 及以上
3. 重新编译项目
4. 在调试器中可以看到，配置了占位组件的组件在首次渲染时会先显示占位组件，然后替换为实际组件

## 下一步

根据实际需求，为需要延迟加载的组件配置占位组件。建议优先为非首屏页面中的大型组件配置。

### 如何判断是否需要用时注入？

1. **查看组件大小**：如果组件代码较大（>10KB），考虑使用
2. **查看使用频率**：非首屏、条件渲染的组件适合使用
3. **测试启动速度**：在配置前后对比小程序启动时间

### 实际配置示例

假设你创建了一个大型的支付表单组件 `components/payment-form/index`，在 `pages/payment/payment.json` 中配置：

```json
{
  "usingComponents": {
    "payment-form": "/components/payment-form/index"
  },
  "componentPlaceholder": {
    "payment-form": "components/placeholder/index"
  }
}
```

这样，`payment-form` 组件就会在首次渲染时才加载，而不是在小程序启动时加载。

