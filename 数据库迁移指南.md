# æ•°æ®åº“è¿ç§»æŒ‡å—ï¼šä» MongoDB åˆ° SQLite

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å¸®åŠ©æ‚¨å°†é¡¹ç›®ä» MongoDB äº‘æ•°æ®åº“è¿ç§»åˆ° SQLiteï¼Œä»¥èŠ‚çœæˆæœ¬ã€‚SQLite æ˜¯å®Œå…¨å…è´¹çš„ï¼Œé€‚åˆå°åˆ°ä¸­ç­‰è§„æ¨¡çš„åº”ç”¨ã€‚

## ğŸ’° æˆæœ¬å¯¹æ¯”

| æ•°æ®åº“ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|--------|------|---------|
| MongoDB Atlas | å…è´¹ç‰ˆï¼š512MBï¼Œä»˜è´¹ç‰ˆï¼š$9+/æœˆ | å¤§è§„æ¨¡åº”ç”¨ï¼Œéœ€è¦åˆ†å¸ƒå¼ |
| SQLite | **å®Œå…¨å…è´¹** | å°åˆ°ä¸­ç­‰è§„æ¨¡ï¼Œå•æœåŠ¡å™¨åº”ç”¨ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£… SQLite ä¾èµ–

```bash
cd backend
npm install sqlite3
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `backend/.env` æ–‡ä»¶ï¼š

```env
# é€‰æ‹©ä½¿ç”¨ SQLite
DB_TYPE=sqlite

# SQLite æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤ï¼š./data/k12_vocabulary.dbï¼‰
SQLITE_PATH=./data/k12_vocabulary.db
```

### 3. å¯åŠ¨æœåŠ¡å™¨

```bash
npm start
```

æœåŠ¡å™¨ä¼šè‡ªåŠ¨ï¼š
- åˆ›å»º SQLite æ•°æ®åº“æ–‡ä»¶
- åˆå§‹åŒ–æ‰€æœ‰è¡¨ç»“æ„
- åˆ›å»ºå¿…è¦çš„ç´¢å¼•

## ğŸ“Š æ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨å·²æœ‰ MongoDB æ•°æ®éœ€è¦è¿ç§»ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ï¼š

### åˆ›å»ºè¿ç§»è„šæœ¬

åˆ›å»º `backend/scripts/migrate-to-sqlite.js`ï¼š

```javascript
const mongoose = require('mongoose');
const SQLiteDB = require('../db/sqlite');
const { initSQLiteModels } = require('../models/index');

async function migrate() {
  // è¿æ¥ MongoDB
  await mongoose.connect(process.env.MONGODB_URI);
  console.log('âœ… MongoDB è¿æ¥æˆåŠŸ');
  
  // è¿æ¥ SQLite
  const db = new SQLiteDB('./data/k12_vocabulary.db');
  await db.connect();
  await db.initTables();
  console.log('âœ… SQLite è¿æ¥æˆåŠŸ');
  
  // åˆå§‹åŒ–æ¨¡å‹
  initSQLiteModels(db);
  const { User, Course, Order, DiscountCode } = require('../models');
  
  // å¯¼å…¥ MongoDB æ¨¡å‹
  const MongoUser = require('../models/User');
  const MongoCourse = require('../models/Course');
  const MongoOrder = require('../models/Order');
  const MongoDiscountCode = require('../models/DiscountCode');
  
  // è¿ç§»ç”¨æˆ·æ•°æ®
  console.log('ğŸ“¦ è¿ç§»ç”¨æˆ·æ•°æ®...');
  const users = await MongoUser.find();
  for (const user of users) {
    await User.create({
      openid: user.openid,
      nickname: user.nickname,
      avatar: user.avatar,
      membership: user.membership,
      membershipExpireTime: user.membershipExpireTime,
      totalTestCount: user.totalTestCount,
      dailyUsage: user.dailyUsage
    });
  }
  console.log(`âœ… å·²è¿ç§» ${users.length} ä¸ªç”¨æˆ·`);
  
  // è¿ç§»è¯¾ç¨‹æ•°æ®
  console.log('ğŸ“¦ è¿ç§»è¯¾ç¨‹æ•°æ®...');
  const courses = await MongoCourse.find();
  for (const course of courses) {
    await Course.create({
      gradeId: course.gradeId,
      gradeName: course.gradeName,
      stage: course.stage,
      level: course.level,
      targetWords: course.targetWords,
      description: course.description,
      enabled: course.enabled,
      wordCount: course.wordCount
    });
  }
  console.log(`âœ… å·²è¿ç§» ${courses.length} ä¸ªè¯¾ç¨‹`);
  
  // è¿ç§»è®¢å•æ•°æ®
  console.log('ğŸ“¦ è¿ç§»è®¢å•æ•°æ®...');
  const orders = await MongoOrder.find();
  for (const order of orders) {
    const user = await User.findOne({ openid: order.openid });
    await Order.create({
      orderId: order.orderId,
      userId: user ? user.id : null,
      openid: order.openid,
      planId: order.planId,
      planName: order.planName,
      amount: order.amount,
      originalAmount: order.originalAmount,
      discountAmount: order.discountAmount,
      discountCode: order.discountCode,
      duration: order.duration,
      status: order.status,
      wxTransactionId: order.wxTransactionId,
      wxPrepayId: order.wxPrepayId,
      paidTime: order.paidTime,
      expireTime: order.expireTime
    });
  }
  console.log(`âœ… å·²è¿ç§» ${orders.length} ä¸ªè®¢å•`);
  
  // è¿ç§»ä¼˜æƒ ç æ•°æ®
  console.log('ğŸ“¦ è¿ç§»ä¼˜æƒ ç æ•°æ®...');
  const discountCodes = await MongoDiscountCode.find();
  for (const code of discountCodes) {
    await DiscountCode.create({
      code: code.code,
      discountAmount: code.discountAmount,
      discountPercent: code.discountPercent,
      type: code.type,
      maxUsage: code.maxUsage,
      validFrom: code.validFrom,
      validUntil: code.validUntil,
      enabled: code.enabled,
      usedCount: code.usedCount
    });
  }
  console.log(`âœ… å·²è¿ç§» ${discountCodes.length} ä¸ªä¼˜æƒ ç `);
  
  // å…³é—­è¿æ¥
  await mongoose.connection.close();
  await db.close();
  console.log('âœ… è¿ç§»å®Œæˆï¼');
}

migrate().catch(console.error);
```

### è¿è¡Œè¿ç§»

```bash
# ç¡®ä¿ .env ä¸­æœ‰ MONGODB_URI
node backend/scripts/migrate-to-sqlite.js
```

## ğŸ”„ åˆ‡æ¢å› MongoDB

å¦‚æœéœ€è¦åˆ‡æ¢å› MongoDBï¼Œåªéœ€ä¿®æ”¹ `.env`ï¼š

```env
DB_TYPE=mongodb
MONGODB_URI=mongodb://your-mongodb-uri
```

## ğŸ“ æ³¨æ„äº‹é¡¹

### SQLite é™åˆ¶

1. **å¹¶å‘å†™å…¥**ï¼šSQLite æ”¯æŒå¹¶å‘è¯»å–ï¼Œä½†å†™å…¥æ—¶ä¼šé”å®šæ•°æ®åº“
   - å¯¹äºå°è§„æ¨¡åº”ç”¨ï¼ˆ< 100 å¹¶å‘ç”¨æˆ·ï¼‰å®Œå…¨å¤Ÿç”¨
   - å¦‚æœå¹¶å‘å†™å…¥é¢‘ç¹ï¼Œè€ƒè™‘ä½¿ç”¨ MongoDB

2. **æ•°æ®å¤§å°**ï¼šSQLite å•æ•°æ®åº“æ–‡ä»¶æœ€å¤§çº¦ 140TB
   - å¯¹äºå¤§å¤šæ•°åº”ç”¨å®Œå…¨å¤Ÿç”¨

3. **å¤‡ä»½**ï¼šSQLite å¤‡ä»½éå¸¸ç®€å•
   ```bash
   # ç›´æ¥å¤åˆ¶æ•°æ®åº“æ–‡ä»¶å³å¯
   cp data/k12_vocabulary.db data/k12_vocabulary.db.backup
   ```

### æ€§èƒ½ä¼˜åŒ–

SQLite å·²å¯ç”¨ä»¥ä¸‹ä¼˜åŒ–ï¼š
- WAL æ¨¡å¼ï¼ˆWrite-Ahead Loggingï¼‰ï¼šæé«˜å¹¶å‘æ€§èƒ½
- å¤–é”®çº¦æŸï¼šä¿è¯æ•°æ®å®Œæ•´æ€§
- è‡ªåŠ¨ç´¢å¼•ï¼šå…³é”®å­—æ®µå·²å»ºç«‹ç´¢å¼•

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q: SQLite æ•°æ®åº“æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ
A: é»˜è®¤åœ¨ `backend/data/k12_vocabulary.db`ï¼Œå¯é€šè¿‡ `SQLITE_PATH` ç¯å¢ƒå˜é‡ä¿®æ”¹ã€‚

### Q: å¦‚ä½•å¤‡ä»½æ•°æ®åº“ï¼Ÿ
A: ç›´æ¥å¤åˆ¶æ•°æ®åº“æ–‡ä»¶å³å¯ï¼š
```bash
cp backend/data/k12_vocabulary.db backend/data/k12_vocabulary.db.backup
```

### Q: å¯ä»¥åŒæ—¶ä½¿ç”¨ä¸¤ç§æ•°æ®åº“å—ï¼Ÿ
A: ä¸å¯ä»¥ï¼Œæ¯æ¬¡åªèƒ½ä½¿ç”¨ä¸€ç§æ•°æ®åº“ç±»å‹ã€‚é€šè¿‡ `DB_TYPE` ç¯å¢ƒå˜é‡åˆ‡æ¢ã€‚

### Q: æ€§èƒ½å¦‚ä½•ï¼Ÿ
A: å¯¹äºå°åˆ°ä¸­ç­‰è§„æ¨¡åº”ç”¨ï¼ˆ< 1000 å¹¶å‘ç”¨æˆ·ï¼‰ï¼ŒSQLite æ€§èƒ½å®Œå…¨å¤Ÿç”¨ã€‚å¦‚æœé‡åˆ°æ€§èƒ½ç“¶é¢ˆï¼Œå¯ä»¥åˆ‡æ¢å› MongoDBã€‚

## ğŸ“š æ›´å¤šä¿¡æ¯

- [SQLite å®˜æ–¹æ–‡æ¡£](https://www.sqlite.org/docs.html)
- [SQLite æ€§èƒ½ä¼˜åŒ–](https://www.sqlite.org/performance.html)
- [MongoDB vs SQLite å¯¹æ¯”](https://www.sqlite.org/whentouse.html)

